{% extends 'layout.html' %}

{% block content %}
<div class="bg-white p-6 md:p-8 rounded-lg shadow-md max-w-4xl mx-auto">
    <div id="progress-section">
        <h2 id="progress-title" class="text-2xl font-bold text-gray-700 mb-4">Mengecek IP di Router...</h2>
        <p class="text-gray-600 mb-6">Harap tunggu, proses ini bisa memakan waktu jika jumlah IP sangat banyak. Jangan tutup halaman ini.</p>
        <div class="mb-4">
            <div class="flex justify-between mb-1"><span id="progress-text" class="text-base font-medium text-blue-700">Memulai...</span><span id="progress-percent" class="text-sm font-medium text-blue-700">0%</span></div>
            <div class="w-full bg-gray-200 rounded-full h-4"><div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div></div>
        </div>
        <pre id="log-output" class="bg-gray-900 text-white p-4 rounded-md h-64 overflow-y-auto font-mono text-sm"></pre>
    </div>

    <div id="confirmation-section" class="hidden animate-fade-in">
        <h2 class="text-2xl font-bold text-gray-700 mb-4">Tahap Konfirmasi</h2>
        <p class="text-sm text-gray-600 mb-4">Pengecekan selesai. Centang client yang ingin Anda isolir, lalu klik tombol konfirmasi.</p>
        <form method="post" action="{{ url_for('execute_isolir') }}">
            <div id="confirmation-table" class="space-y-2 max-h-96 overflow-y-auto border p-2 rounded-md">
                </div>
            <div class="mt-6 text-right">
                <button type="submit" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded" onclick="return confirm('Anda yakin ingin mengisolir semua client yang dicentang?');">
                    Konfirmasi dan Isolir Pilihan
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const taskId = "{{ task_id }}";
    let lastResultIndex = 0;

    function checkStatus() {
        fetch(`/api/isolir/status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                if(data.status === 'error') {
                    $('#progress-text').text(data.message);
                    clearInterval(intervalId);
                    return;
                }

                const total = data.total || 0;
                const progress = data.progress || 0;
                const percentage = total > 0 ? Math.round((progress / total) * 100) : 0;
                
                $('#progress-bar').css('width', percentage + '%');
                $('#progress-percent').text(percentage + '%');
                $('#progress-text').text(`Mengecek ${progress} dari ${total}...`);

                if (data.results && data.results.length > lastResultIndex) {
                    const newResults = data.results.slice(lastResultIndex).map(r => `<div>${r}</div>`);
                    $('#log-output').append(newResults.join('')).scrollTop($('#log-output')[0].scrollHeight);
                    lastResultIndex = data.results.length;
                }
                
                // Jika proses pengecekan selesai
                if (data.type === 'checking' && data.status === 'completed') {
                    clearInterval(intervalId);
                    $('#progress-section').slideUp();
                    displayConfirmation(data.preview_data);
                    $('#confirmation-section').slideDown();
                }
            })
            .catch(error => {
                console.error('Gagal mengambil status:', error);
                $('#log-output').append('<div>Error: Gagal terhubung ke server. Hentikan polling.</div>');
                clearInterval(intervalId);
            });
    }

    function displayConfirmation(previewData) {
        const tableContainer = $('#confirmation-table');
        tableContainer.empty();
        previewData.forEach(item => {
            const canIsolate = item.id && item.status === 'Aktif';
            const bgColor = canIsolate ? 'bg-green-50' : 'bg-gray-100';
            const statusColor = item.status === 'Aktif' ? 'text-green-600' : (item.status === 'Sudah Diisolir' ? 'text-yellow-600' : 'text-red-500');

            // Format value: "id|base_url|comment|ip"
            const checkboxValue = `${item.id}|${item.base_url}|${item.comment}|${item.ip}`;

            const rowHtml = `
                <div class="p-3 rounded-md flex items-center gap-4 ${bgColor} border">
                    <div class="w-6 flex-shrink-0"><input type="checkbox" name="to_isolate" value="${checkboxValue}" class="h-5 w-5 rounded" ${canIsolate ? '' : 'disabled'}></div>
                    <div class="flex-grow grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div><p class="text-xs text-gray-500">Nama (Comment)</p><p class="font-medium break-words">${item.comment}</p></div>
                        <div><p class="text-xs text-gray-500">IP Address</p><p class="font-mono">${item.ip}</p></div>
                        <div><p class="text-xs text-gray-500">Status</p><p class="font-semibold ${statusColor}">${item.status}</p></div>
                    </div>
                </div>
            `;
            tableContainer.append(rowHtml);
        });
    }

    const intervalId = setInterval(checkStatus, 2500); // Poll setiap 2.5 detik
});
</script>
{% endblock %}